name: "GLPI Docker Image Build (Template)"

# This is a reusable workflow template - never run directly
# Called by: glpi.yml, glpi-nightly.yml

env:
  DOCKERHUB_IMAGE: glpi/glpi
  GHCR_IMAGE: ghcr.io/glpi-project/glpi

on:
  workflow_call:
    inputs:
      push:
        description: "Whether to push images to registries"
        required: false
        type: boolean
        default: false
      post-extract-commands:
        description: "Custom bash commands to run after source extraction (i.e: patches)"
        required: false
        type: string
        default: ""
      php-version:
        required: false
        type: string
        default: "8.5"
      glpi-version:
        description: "GLPI version or branch to build"
        required: true
        type: string
      image-tag:
        description: "Override image tag. If not set, computed from version."
        required: false
        type: string
        default: ""
      image-suffix:
        description: "Suffix to add to computed tag (ignored if image-tag is set)"
        required: false
        type: string
        default: ""
    secrets:
      DOCKER_HUB_USERNAME:
        required: true
      DOCKER_HUB_TOKEN:
        required: true
      GHCR_USERNAME:
        required: true
      GHCR_ACCESS_TOKEN:
        required: true

jobs:
  prepare:
    name: "Prepare"
    runs-on: "ubuntu-latest"
    outputs:
      platforms: ${{ steps.set-matrix.outputs.platforms }}
      marketplace-dir: ${{ steps.set-vars.outputs.marketplace_dir }}
      tags: ${{ steps.set-vars.outputs.tags }}
    steps:
      - name: "Set matrix"
        id: "set-matrix"
        run: |
          echo 'platforms<<EOF' >> $GITHUB_OUTPUT
          echo '[
            {"arch": "linux/amd64", "runner": "ubuntu-24.04", "suffix": "amd64"},
            {"arch": "linux/arm64", "runner": "ubuntu-24.04-arm", "suffix": "arm64"}
          ]' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: "Set variables"
        id: "set-vars"
        run: |
          # Compute marketplace dir
          IMAGE_VERSION_MAJOR=$(echo "${{ inputs.glpi-version }}" | cut -d. -f1)
          MARKETPLACE_DIR="/var/glpi/marketplace"
          if [[ "$IMAGE_VERSION_MAJOR" = "10" ]]; then
            MARKETPLACE_DIR="/var/www/glpi/marketplace"
          fi
          echo "marketplace_dir=$MARKETPLACE_DIR" >> $GITHUB_OUTPUT

          # Compute tags
          if [[ "${{ inputs.image-tag }}" != '' ]]; then
            # Use provided tag directly
            TAGS="${{ env.DOCKERHUB_IMAGE }}:${{ inputs.image-tag }},${{ env.GHCR_IMAGE }}:${{ inputs.image-tag }}"
          else
            # Compute from version
            IMAGE_VERSION="$(echo '${{ inputs.glpi-version }}' | sed -E 's|/|-|')"
            IMAGE_VERSION_MAJOR=$(echo "${{ inputs.glpi-version }}" | cut -d. -f1)
            IMAGE_VERSION_MINOR=$(echo "${{ inputs.glpi-version }}" | cut -d. -f1-2)

            if [[ "${{ inputs.image-suffix }}" != '' ]]; then
              IMAGE_VERSION="$IMAGE_VERSION-${{ inputs.image-suffix }}"
            fi

            TAGS="${{ env.DOCKERHUB_IMAGE }}:$IMAGE_VERSION,${{ env.GHCR_IMAGE }}:$IMAGE_VERSION"

            PRERELEASE_FLAG="$( echo "${{ inputs.glpi-version }}" | grep -Po '(\-\w+)?$' )"
            if [[ -z "$PRERELEASE_FLAG" ]]; then
              TAGS="$TAGS,${{ env.DOCKERHUB_IMAGE }}:$IMAGE_VERSION_MAJOR,${{ env.GHCR_IMAGE }}:$IMAGE_VERSION_MAJOR"
              TAGS="$TAGS,${{ env.DOCKERHUB_IMAGE }}:$IMAGE_VERSION_MINOR,${{ env.GHCR_IMAGE }}:$IMAGE_VERSION_MINOR"

              LATEST_TAG="$(curl -s https://api.github.com/repos/glpi-project/glpi/releases/latest | jq -r .tag_name)"
              if [[ "${{ inputs.glpi-version }}" = "$LATEST_TAG" ]]; then
                TAGS="$TAGS,${{ env.DOCKERHUB_IMAGE }}:latest,${{ env.GHCR_IMAGE }}:latest"
              fi
            fi
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

  build:
    name: "Build [${{ matrix.platform.suffix }}]"
    runs-on: "${{ matrix.platform.runner }}"
    needs: [prepare]
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v6"

      - name: "Prepare environment"
        run: |
          platform="${{ matrix.platform.arch }}"
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: "Docker meta"
        id: "meta"
        uses: "docker/metadata-action@v5"
        with:
          images: |
            ${{ env.DOCKERHUB_IMAGE }}
            ${{ env.GHCR_IMAGE }}

      - name: "Get sources from glpi-project/glpi"
        run: |
          curl https://github.com/glpi-project/glpi/archive/${{ inputs.glpi-version }}.tar.gz --location --output glpi.tar.gz
          mkdir -p glpi/sources
          tar --extract --ungzip --strip 1 --file glpi.tar.gz --directory glpi/sources

      - name: "Run post-extract commands"
        if: ${{ inputs.post-extract-commands != '' }}
        run: |
          ${{ inputs.post-extract-commands }}

      - name: "Set up QEMU"
        uses: "docker/setup-qemu-action@v3"

      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"

      - name: "Login to DockerHub"
        uses: "docker/login-action@v3"
        with:
          username: "${{ secrets.DOCKER_HUB_USERNAME }}"
          password: "${{ secrets.DOCKER_HUB_TOKEN }}"

      - name: "Login to Github container registry"
        uses: "docker/login-action@v3"
        with:
          registry: "ghcr.io"
          username: "${{ secrets.GHCR_USERNAME }}"
          password: "${{ secrets.GHCR_ACCESS_TOKEN }}"

      - name: "Build and push by digest"
        id: "build"
        uses: "docker/build-push-action@v6"
        with:
          build-args: |
            BUILDER_IMAGE=php:${{ inputs.php-version }}-cli-alpine
            APP_IMAGE=php:${{ inputs.php-version }}-apache
            GLPI_MARKETPLACE_DIR=${{ needs.prepare.outputs.marketplace-dir }}
          cache-from: |
            type=gha,scope=${{ github.ref_name }}-${{ matrix.platform.suffix }}
            type=gha,scope=main-${{ matrix.platform.suffix }}
          cache-to: "type=gha,mode=max,scope=${{ github.ref_name }}-${{ matrix.platform.suffix }}"
          context: "glpi"
          labels: "${{ steps.meta.outputs.labels }}"
          platforms: "${{ matrix.platform.arch }}"
          pull: true
          outputs: "type=image,\"name=${{ env.DOCKERHUB_IMAGE }},${{ env.GHCR_IMAGE }}\",push-by-digest=true,name-canonical=true,push=${{ inputs.push }}"

      - name: "Export digest"
        if: ${{ inputs.push }}
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: "Upload digest"
        if: ${{ inputs.push }}
        uses: "actions/upload-artifact@v4"
        with:
          name: "digests-${{ env.PLATFORM_PAIR }}"
          path: "${{ runner.temp }}/digests/*"
          if-no-files-found: "error"
          retention-days: 1

  merge-manifests:
    name: "Merge manifests"
    runs-on: "ubuntu-latest"
    needs: [prepare, build]
    if: ${{ inputs.push }}
    steps:
      - name: "Download digests"
        uses: "actions/download-artifact@v4"
        with:
          path: "${{ runner.temp }}/digests"
          pattern: "digests-*"
          merge-multiple: true
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
      - name: "Login to DockerHub"
        uses: "docker/login-action@v3"
        with:
          username: "${{ secrets.DOCKER_HUB_USERNAME }}"
          password: "${{ secrets.DOCKER_HUB_TOKEN }}"
      - name: "Login to Github container registry"
        uses: "docker/login-action@v3"
        with:
          registry: "ghcr.io"
          username: "${{ secrets.GHCR_USERNAME }}"
          password: "${{ secrets.GHCR_ACCESS_TOKEN }}"
      - name: "Create and push manifest"
        working-directory: "${{ runner.temp }}/digests"
        run: |
          # Build the tag arguments
          TAG_ARGS=""
          IFS=',' read -ra TAG_ARRAY <<< "${{ needs.prepare.outputs.tags }}"
          for tag in "${TAG_ARRAY[@]}"; do
            TAG_ARGS="$TAG_ARGS -t $tag"
          done

          # Create manifest
          docker buildx imagetools create $TAG_ARGS \
            $(printf '${{ env.DOCKERHUB_IMAGE }}@sha256:%s ' *)
      - name: "Inspect image"
        run: |
          # Get first tag for inspection
          FIRST_TAG=$(echo "${{ needs.prepare.outputs.tags }}" | cut -d',' -f1)
          docker buildx imagetools inspect $FIRST_TAG
