version: 2.1

commands:
  build:
    parameters:
      path:
        type: string
        default: "circleci-env-core"
      base_image:
        type: string
        default: "circleci/php:latest-node"
      tag:
        type: string
        default: "glpi/circleci-env-core:php_latest_fpm-node"
    steps:
      - run:
          name: "Build docker image"
          command: |
            docker build --pull --tag << parameters.tag >> --build-arg BASE_IMAGE=<< parameters.base_image >> << parameters.path >>
      - run:
          name: "Push docker image"
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u $DOCKER_USER -p $DOCKER_PASS
              docker push << parameters.tag >>
            fi

jobs:
  build_all_circleci-env-core:
    docker:
      - image: docker:18-git
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:5.6-fpm-stretch-node"
          tag: "glpi/circleci-env-core:php_5.6_fpm-node"
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:7.0-fpm-stretch-node"
          tag: "glpi/circleci-env-core:php_7.0_fpm-node"
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:7.1-fpm-stretch-node"
          tag: "glpi/circleci-env-core:php_7.1_fpm-node"
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:7.2-fpm-stretch-node"
          tag: "glpi/circleci-env-core:php_7.2_fpm-node"
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:7.3-fpm-node"
          tag: "glpi/circleci-env-core:php_7.3_fpm-node"
      - build:
          path: "circleci-env-core"
          base_image: "circleci/php:latest-node"
          tag: "glpi/circleci-env-core:php_latest_fpm-node"
  build_all_githubactions_images:
    docker:
      - image: docker:18-git
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - build:
          path: "githubactions-php"
          base_image: "php:5.6-fpm-alpine"
          tag: "glpi/githubactions-php:5.6"
      - build:
          path: "githubactions-php"
          base_image: "php:7.0-fpm-alpine"
          tag: "glpi/githubactions-php:7.0"
      - build:
          path: "githubactions-php"
          base_image: "php:7.1-fpm-alpine"
          tag: "glpi/githubactions-php:7.1"
      - build:
          path: "githubactions-php"
          base_image: "php:7.2-fpm-alpine"
          tag: "glpi/githubactions-php:7.2"
      - build:
          path: "githubactions-php"
          base_image: "php:7.3-fpm-alpine"
          tag: "glpi/githubactions-php:7.3"
      - build:
          path: "githubactions-php"
          base_image: "php:7.3-fpm-alpine"
          tag: "glpi/githubactions-php:latest"
      - build:
          path: "githubactions-php"
          base_image: "php:7.4-rc-fpm-alpine"
          tag: "glpi/githubactions-php:7.4-rc"
      - build:
          path: "githubactions-db"
          base_image: "mariadb:10.1"
          tag: "glpi/githubactions-mariadb:10.1"
      - build:
          path: "githubactions-db"
          base_image: "mariadb:10.2"
          tag: "glpi/githubactions-mariadb:10.2"
      - build:
          path: "githubactions-db"
          base_image: "mariadb:10.3"
          tag: "glpi/githubactions-mariadb:10.3"
      - build:
          path: "githubactions-db"
          base_image: "mariadb:10.4"
          tag: "glpi/githubactions-mariadb:10.4"
      - build:
          path: "githubactions-db"
          base_image: "mysql:5.6"
          tag: "glpi/githubactions-mysql:5.6"
      - build:
          path: "githubactions-db"
          base_image: "mysql:5.7"
          tag: "glpi/githubactions-mysql:5.7"
      - build:
          path: "githubactions-db"
          base_image: "mysql:8.0"
          tag: "glpi/githubactions-mysql:8.0"
      - build:
          path: "githubactions-dovecot"
          base_image: "debian:buster-slim"
          tag: "glpi/githubactions-dovecot:latest"
      - build:
          path: "githubactions-openldap"
          base_image: "alpine"
          tag: "glpi/githubactions-openldap:latest"

workflows:
  # Build images every time a PR is created or a branch is updated.
  pr_build:
    jobs:
      - build_all_circleci-env-core
      - build_all_githubactions_images

  # Weekly build to be sure to have latest PHP bugfixes in images
  # even if no changes were made on master branch.
  weekly_build:
    triggers:
      - schedule:
          cron: "0 0 * * 0"
          filters:
            branches:
              only:
                - master
    jobs:
      - build_all_circleci-env-core
      - build_all_githubactions_images
